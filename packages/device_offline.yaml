---
template:
  - trigger:
      - platform: 'time_pattern'
        minutes: '*'
      - platform: 'state'
        entity_id: 'binary_sensor.zigbee2mqtt_state'
      - platform: 'event'
        event_type: 'entity_registry_updated'
    sensor:
      - name: 'Unavailable Entities'
        unique_id: '5c27c9c2-bee0-461f-bb08-3fc5abde1340'
        state: >-
          {{
            states | selectattr('state', 'eq', 'unavailable') |
            rejectattr('domain', 'eq', 'group') |
            rejectattr('entity_id', 'in', state_attr('group.ignored_entities', 'entity_id')) |
            map(attribute='entity_id') | list | count
          }}
        unit_of_measurement: 'entities'
        icon: '{{ is_state("sensor.unavailable_entities", "0") | iif("mdi:check-circle", "mdi:alert-circle") }}'
        attributes:
          entities: >-
            {{
              states | selectattr('state', 'in', ['unavailable']) |
              rejectattr('domain', 'eq', 'group') |
              rejectattr('entity_id', 'in', state_attr('group.ignored_entities', 'entity_id')) |
              map(attribute='entity_id') | list
            }}

group:
  ignored_entities:
    entities:
      - 'group.ignored_firmware_updates'
      - 'sensor.josh_phone_next_alarm'
      - 'sensor.lily_phone_next_alarm'
      - 'sensor.unavailable_entities'
      - 'vacuum.deebot'

automation:
  - alias: 'Device Offline'
    id: '7fa5aace-5294-4181-a6f3-4720b1fe1fde'
    trigger:
      platform: 'state'
      entity_id: 'sensor.unavailable_entities'
    condition:
      - condition: 'state'
        entity_id: 'binary_sensor.zigbee2mqtt_state'
        state: 'on'
      - condition: 'numeric_state'
        entity_id: 'sensor.uptime'
        value_template: '{{ (now() - as_datetime(state.state)).seconds }}'
        above: 120
    action:
      choose:
        conditions:
          condition: 'numeric_state'
          entity_id: 'sensor.unavailable_entities'
          below: 1
        sequence:
          service: 'script.mobile_app_clear_notification'
          data:
            target: 'josh_phone'
            tag: 'devices-offline'
      default:
        service: 'script.mobile_app_notify'
        data:
          target: 'josh_phone'
          title: 'Device(s) Offline'
          message: >-
            {{ states('sensor.unavailable_entities') }} devices are offline.

            {% for entity in state_attr('sensor.unavailable_entities', 'entities') -%}
            - {{ entity }}
            {% endfor %}
          tag: 'devices-offline'
    mode: 'restart'
    trace:
      stored_traces: 10

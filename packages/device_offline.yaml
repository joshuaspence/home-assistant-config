---
template:
  - trigger:
      - platform: 'time_pattern'
        minutes: '*'
      - platform: 'state'
        entity_id: 'binary_sensor.zigbee2mqtt_state'
      - platform: 'event'
        event_type: 'entity_registry_updated'
    sensor:
      - name: 'Unavailable Entities'
        unique_id: '5c27c9c2-bee0-461f-bb08-3fc5abde1340'
        state: >-
          {{
            states | selectattr('state', 'eq', 'unavailable') |
            rejectattr('domain', 'eq', 'group') |
            rejectattr('entity_id', 'in', state_attr('group.ignored_entities', 'entity_id')) |
            map(attribute='entity_id') | list | count
          }}
        unit_of_measurement: 'entities'
        icon: >-
          {% if is_state('sensor.unavailable_entities', '0') %}
            mdi:check-circle
          {% else %}
            mdi:alert-circle
          {% endif %}
        attributes:
          entities: >-
            {{
              states | selectattr('state', 'in', ['unavailable']) |
              rejectattr('domain', 'eq', 'group') |
              rejectattr('entity_id', 'in', state_attr('group.ignored_entities', 'entity_id')) |
              map(attribute='entity_id') | list
            }}

group:
  ignored_entities:
    entities:
      - 'group.ignored_firmware_updates'
      - 'media_player.hallway_speaker'
      - 'media_player.living_room_speaker'
      - 'media_player.living_room_tv'
      - 'media_player.office_speaker'
      - 'media_player.outside_speaker'
      - 'person.michael_spence'
      - 'sensor.unavailable_entities'
      - 'sensor.unifi_gateway_board_cpu_temperature'
      - 'sensor.unifi_gateway_board_phy_temperature'
      - 'sensor.unifi_gateway_cpu_temperature'
      - 'sensor.unifi_gateway_phy_temperature'
      - 'vacuum.downstairs'

automation:
  - alias: 'Device Offline'
    id: '7fa5aace-5294-4181-a6f3-4720b1fe1fde'
    trigger:
      platform: 'state'
      entity_id: 'sensor.unavailable_entities'
    condition:
      condition: 'numeric_state'
      entity_id: 'sensor.uptime'
      value_template: '{{ (now() - as_datetime(state.state)).seconds }}'
      above: 120
    action:
      choose:
        conditions:
          condition: 'numeric_state'
          entity_id: 'sensor.unavailable_entities'
          below: 1
        sequence:
          service: 'notify.mobile_app_josh_phone'
          data:
            message: 'clear_notification'
            data:
              tag: 'devices-offline'
      default:
        service: 'notify.mobile_app_josh_phone'
        data:
          title: 'Device(s) Offline'
          message: >-
            {{ states('sensor.unavailable_entities') }} devices are offline.

            {% for entity in state_attr('sensor.unavailable_entities', 'entities') -%}
            - {{ entity }}
            {% endfor %}
          data:
            tag: 'devices-offline'
    mode: 'restart'

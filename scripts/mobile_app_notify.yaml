---
alias: 'Mobile App Notify'
description: 'A wrapper script for `notify.mobile_app`.'
icon: 'mdi:message'
mode: 'parallel'
max: 10
trace:
  stored_traces: 20

fields:
  target:
    name: 'Target Device'
    description: 'Target device to send the notification to.'
    required: true
    selector:
      device:
        integration: 'mobile_app'
  title:
    name: 'Title'
    description: 'Title for the notification.'
    required: true
    selector:
      text: {}
  subtitle:
    name: 'Subtitle'
    description: 'A secondary heading for the notification.'
    advanced: true
    selector:
      text: {}
  message:
    name: 'Message'
    description: 'Message body of the notification.'
    required: true
    selector:
      text:
        multiline: true
  actions:
    name: 'Actions'
    description: 'Actionable buttons added to the notification.'
    advanced: true
    selector:
      object: null

  group:
    name: 'Group'
    description: 'Combine notifications together visually.'
    advanced: true
    selector:
      text: {}
  icon:
    name: 'Icon URL'
    description: 'Add an icon to the notification.'
    advanced: true
    selector:
      text: {}
  persistent:
    name: 'Persistent'
    description: >-
      Persistent notifications cannot be dimissed by swiping away. In order to
      use this property you must also set the `tag` property.
    advanced: true
    selector:
      boolean: null
  sticky:
    name: 'Sticky'
    description: 'Prevent the notification from being dismissed when the user selects it.'
    advanced: true
    selector:
      boolean: null
  tag:
    name: 'Tag'
    description: >-
      Replace an existing notification by using a tag. To clear an existing
      notification which has a tag, set `message` to `clear_notification`.
    advanced: true
    selector:
      text: {}
  url:
    name: 'URL'
    description: 'URL to open when notification is tapped.'
    advanced: true
    selector:
      text: {}

variables:
  device: >-
    {% if device_attr(target, 'id') is not none %}
      {{ device_attr(target, 'name_by_user') | regex_replace(find="'s\\b", replace="") | slugify }}
    {% else %}
      {{ target }}
    {% endif %}
  metadata:
    actions: '{{ actions | default(None) }}'
    clickAction: '{{ url | default(None) }}'
    group: '{{ group | default(None) }}'
    icon_url: '{{ icon | default(None)}}'
    persistent: '{{ persistent | default(None) }}'
    sticky: '{{ sticky | default(None) }}'
    subject: '{{ subtitle | default(None) }}'
    tag: '{{ tag | default(None) }}'

sequence:
  service: 'notify.mobile_app_{{ device }}'
  data:
    title: '{{ title }}'
    message: '{{ message }}'
    data: '{{ dict(metadata.items() | rejectattr("1", "none")) }}'

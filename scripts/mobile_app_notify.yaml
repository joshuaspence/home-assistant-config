---
alias: 'Mobile App Notify'
description: 'A wrapper script for `notify.mobile_app`.'
icon: 'mdi:message'
mode: 'parallel'
max: 10
trace:
  stored_traces: 20

fields:
  target:
    name: 'Target Device'
    description: 'Target device to send the notification to.'
    required: true
    selector:
      device:
        integration: 'mobile_app'
  title:
    name: 'Title'
    description: 'Title for the notification.'
    required: true
    selector:
      text: {}
  subtitle:
    name: 'Subtitle'
    description: 'A secondary heading for the notification.'
    advanced: true
    selector:
      text: {}
  message:
    name: 'Message'
    description: 'Message body of the notification.'
    required: true
    selector:
      text:
        multiline: true

  tag:
    name: 'Tag'
    description: >-
      Replace an existing notification by using a tag. To clear an existing
      notification which has a tag, set `message` to `clear_notification`.
    advanced: true
    selector:
      text: {}

variables:
  device: >-
    {% if device_attr(target, 'id') is not none %}
      {{ device_attr(target, 'name_by_user') | regex_replace(find="'s\\b", replace="") | slugify }}
    {% else %}
      {{ target }}
    {% endif %}
  metadata:
    subject: '{{ subtitle | default(None) }}'
    tag: '{{ tag | default(None) }}'

sequence:
  service: 'notify.mobile_app_{{ device }}'
  data:
    title: !input 'title'
    message: !input 'message'
    data: '{{ dict(metadata.items() | rejectattr("1", "none")) }}'
